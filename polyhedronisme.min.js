(function(){var bc,a0,aK,aq,L,br,j,aS,l,k,R,t,bb,aP,aa,V,h,bK,ai,Y,P,x,bE,T,bG,u,aY,bl,aJ,aZ,p,ao,by,aB,M,bz,ax,bh,E,a5,W,aR,bN,bw,bj,a1,bn,al,ak,be,aD,a8,aT,bH,bs,an,bJ,aC,v,aX,bm,am,aG,bd,bA,A,H,d,q,D,ab,aH,C,a3,bF,bD,a7,r,bp,J,aL,a9,e,aj,ba,bL,aA,a,bk,ar,n,aI,bv,bu,Z,y,av,G,Q,O,af,bq,N,z,bB,bI,bt,bM,a2,aU,f,aV,bi,U,aW,a6,ag,bx,ac,X,ae,i,aw,w,ah,c,ap,aQ,aE,m,au,F,bo,s,a4,bg,bf,aF,b,S,ay,bC,I,aO,o,B,g,az,at,aN,ad,aM,K;aW=Math.random;w=Math.round;bm=Math.floor;bo=Math.sqrt;aQ=Math.sin;W=Math.cos;bf=Math.tan;aY=Math.asin;Y=Math.acos;bl=Math.atan;aU=Math.pow;ai=Math.abs;aa=Math.PI;aS=Math.LN10;a9=Math.log;aU=Math.pow;e=function(bO){return a9(bO)/aS};ap=function(bQ,bP){var bO;bO=aU(10,e(bQ)-bm(e(bQ)));return""+(w(bO*(bP-1)))};bh=function(bQ){var bP,bO;if((bQ==null)||typeof bQ!=="object"){return bQ}bO=new bQ.constructor();for(bP in bQ){bO[bP]=bh(bQ[bP])}return bO};a6=function(bP){var bO;bO=bm(aW()*bP.length);return bP[bO]};a=function(bP,bO){return[bP*bO[0],bP*bO[1],bP*bO[2]]};K=function(bP,bO){return[bP[0]*bO[0],bP[1]*bO[1],bP[2]*bO[2]]};P=function(bP,bO){return[bP[0]+bO[0],bP[1]+bO[1],bP[2]+bO[2]]};a4=function(bP,bO){return[bP[0]-bO[0],bP[1]-bO[1],bP[2]-bO[2]]};be=function(bP,bO){return bP[0]*bO[0]+bP[1]*bO[1]+bP[2]*bO[2]};aR=function(bP,bO){return[bP[1]*bO[2]-bP[2]*bO[1],bP[2]*bO[0]-bP[0]*bO[2],bP[0]*bO[1]-bP[1]*bO[0]]};aD=function(bP,bO){return bP[0]*bO[0]+bP[1]*bO[1]};bN=function(bP,bO){return bP[0]*bO[1]-bP[1]*bO[0]};x=function(bP,bO){return[bP[0]+bO[0],bP[1]+bO[1]]};bg=function(bP,bO){return[bP[0]-bO[0],bP[1]-bO[1]]};M=function(bO){if(ai(bO)<1e-10){return 0}else{return bO}};aj=function(bO){return bo(be(bO,bO))};ba=function(bO){return be(bO,bO)};az=function(bO){return a(1/bo(ba(bO)),bO)};bL=function(bP,bO){return a(1/2,P(bP,bO))};B=function(bQ,bP,bO){return[(1-bO)*bQ[0]+bO*bP[0],(1-bO)*bQ[1]+bO*bP[1],(1-bO)*bQ[2]+bO*bP[2]]};bv=function(bP,bO){return B(bP,bO,1/3)};bx=function(bO){return a(1/ba(bO),bO)};aF=function(bQ,bP){var bO;bO=a4(bP,bQ);return a4(bQ,a(be(bO,bQ)/ba(bO),bO))};bs=function(bP,bO){return bo(ba(aF(bP,bO)))};y=function(bS,bR,bQ){var bP,bO;bP=a4(bR,bS);bO=a4(bQ,bR);return aR(bP,bO)};a7=function(bV,bU,bT){var bZ,bY,bX,bS,bR,bQ,bW,bP,bO;for(bS=0,bW=bV.length;bS<bW;bS++){bZ=bV[bS];for(bR=0,bP=bU.length;bR<bP;bR++){bY=bU[bR];if(bZ===bY){for(bQ=0,bO=bT.length;bQ<bO;bQ++){bX=bT[bQ];if(bZ===bX){return bZ}}}}}return null};aZ=function(bS){var bQ,bP,bR,bO;bQ=[0,0,0];for(bR=0,bO=bS.length;bR<bO;bR++){bP=bS[bR];bQ=P(bQ,bP)}return a(1/bS.length,bQ)};n=function(bS){var bO,bW,bU,bT,bQ,bV,bR,bP;bO=[0,0,0];bR=bS.slice(-2),bW=bR[0],bU=bR[1];for(bQ=0,bV=bS.length;bQ<bV;bQ++){bT=bS[bQ];bO=P(bO,y(bW,bU,bT));bP=[bU,bT],bW=bP[0],bU=bP[1]}return az(bO)};p=function(bY){var bP,bO,b4,bU,bS,bQ,b3,b2,b0,bZ,bW,b1,bX,bV,bT,bR;bX=bY[0],b2=bX[0],b0=bX[1],bZ=bX[2];bV=[b2,b2],bP=bV[0],bU=bV[1];bT=[b0,b0],bO=bT[0],bS=bT[1];bR=[bZ,bZ],b4=bR[0],bQ=bR[1];for(bW=0,b1=bY.length;bW<b1;bW++){b3=bY[bW];b2=b3[0],b0=b3[1],bZ=b3[2];bP=bP<b2?b2:bP;bU=bU>b2?b2:bU;bO=bO<b0?b0:bO;bS=bS>b0?b0:bS;b4=b4<bZ?bZ:b4;bQ=bQ>bZ?bZ:bQ}return[[bU,bP],[bS,bO],[bQ,b4]]};ao=function(ca,b4,bY,bX,bU){var b9,b7,b5,cb,b8,b6,bW,bV,b3,b2,b1,bZ,bR,cc,b0,bT,bS,bQ,bP,bO;b0=ca[0],b2=b0[0],b1=b0[1],bZ=b0[2];bT=O(ca[0],b4,bY,bX,bU),bW=bT[0],bV=bT[1];bS=[bW,bW],b9=bS[0],cb=bS[1];bQ=[bV,bV],b7=bQ[0],b8=bQ[1];bP=[bZ,bZ],b5=bP[0],b6=bP[1];for(bR=0,cc=ca.length;bR<cc;bR++){b3=ca[bR];b2=b3[0],b1=b3[1],bZ=b3[2];bO=O(b3,b4,bY,bX,bU),bW=bO[0],bV=bO[1];b9=b9<bW?bW:b9;cb=cb>bW?bW:cb;b7=b7<bV?bV:b7;b8=b8>bV?bV:b8;b5=b5<bZ?bZ:b5;b6=b6>bZ?bZ:b6}return[[cb,b9],[b8,b7],[b6,b5]]};E=function(bS){var bO,bW,bU,bT,bQ,bV,bR,bP;bO=0;bR=bS.slice(0,2),bW=bR[0],bU=bR[1];bP=bS.slice(2);for(bQ=0,bV=bP.length;bQ<bV;bQ++){bT=bP[bQ];bO+=aj(aR(a4(bU,bW),a4(bT,bW)));bU=bT}return bO};aC=function(bX){var bW,b3,b2,b0,bY,b1,bU,bT,bR,bZ,bP,bO,bV,bS,bQ;bW=[];bV=bX.slice(0,2),b2=bV[0],b0=bV[1];bS=bX.slice(2);for(bU=0,bZ=bS.length;bU<bZ;bU++){bY=bS[bU];bW.push(aj(aR(a4(b0,b2),a4(bY,b2))));b0=bY}bW.sort(function(b5,b4){return b5-b4});b3="";for(bT=0,bP=bW.length;bT<bP;bT++){b1=bW[bT];b3+=ap(b1,2)}bQ=bW.reverse();for(bR=0,bO=bQ.length;bR<bO;bR++){b1=bQ[bR];b3+=ap(b1,2)}return b3};aV=function(bV){var bT,bP,bO,bS,bW,bX,bR,bU,bQ;bS=bh(bV);bX=bV[0];bS=_.map(bS,function(bY){return bY-bX});bP=n(bV);bT=az(aZ(bV));bO=aR(bP,bT);bQ=[];for(bR=0,bU=bS.length;bR<bU;bR++){bW=bS[bR];bQ.push([be(bP,bW),be(bO,bW)])}return bQ};a5=function(bQ){var bP,bO,bS,bR;bO=new Array(bQ.length);for(bP=bS=0,bR=bQ.length-1;0<=bR?bS<=bR:bS>=bR;bP=0<=bR?++bS:--bS){bO[bP]=bQ[bP].slice(0)}return bO};bk=function(bP,bO){return[bP[0][0]*bO[0]+bP[0][1]*bO[1]+bP[0][2]*bO[2],bP[1][0]*bO[0]+bP[1][1]*bO[1]+bP[1][2]*bO[2],bP[2][0]*bO[0]+bP[2][1]*bO[1]+bP[2][2]*bO[2]]};aA=function(bO,bP){return[[bO[0][0]*bP[0][0]+bO[0][1]*bP[1][0]+bO[0][2]*bP[2][0],bO[0][0]*bP[0][1]+bO[0][1]*bP[1][1]+bO[0][2]*bP[2][1],bO[0][0]*bP[0][2]+bO[0][1]*bP[1][2]+bO[0][2]*bP[2][2]],[bO[1][0]*bP[0][0]+bO[1][1]*bP[1][0]+bO[1][2]*bP[2][0],bO[1][0]*bP[0][1]+bO[1][1]*bP[1][1]+bO[1][2]*bP[2][1],bO[1][0]*bP[0][2]+bO[1][1]*bP[1][2]+bO[1][2]*bP[2][2]],[bO[2][0]*bP[0][0]+bO[2][1]*bP[1][0]+bO[2][2]*bP[2][0],bO[2][0]*bP[0][1]+bO[2][1]*bP[1][1]+bO[2][2]*bP[2][1],bO[2][0]*bP[0][2]+bO[2][1]*bP[1][2]+bO[2][2]*bP[2][2]]]};bJ=[[1,0,0],[0,1,0],[0,0,1]];aw=function(bS,bQ,bR){var bT,bP,bO;bT=[[W(bS),-1*aQ(bS),0],[aQ(bS),W(bS),0],[0,0,1]];bO=[[W(bQ),0,-1*aQ(bQ)],[0,1,0],[aQ(bQ),0,W(bQ)]];bP=[[1,0,0],[0,W(bR),-1*aQ(bR)],[0,aQ(bR),W(bR)]];return aA(bP,aA(bO,bT))};at=function(bR,b1,bZ,bW){var bV,bP,bQ,b0,bY,bO,bX,bT,bU,bS;bR/=2;b0=aQ(bR);bV=W(bR);bY=b0*b0;bP=aj([b1,bZ,bW]);if(bP===0){bU=[0,0,1],b1=bU[0],bZ=bU[1],bW=bU[2]}if(bP!==1){bS=az([b1,bZ,bW]),b1=bS[0],bZ=bS[1],bW=bS[2]}if(b1===1&&bZ===0&&bW===0){bQ=[[1,0,0],[0,1-2*bY,2*b0*bV],[0,-2*b0*bV,1-2*bY]]}else{if(b1===0&&bZ===1&&bW===0){bQ=[[1-2*bY,0,-2*b0*bV],[0,1,0],[2*b0*bV,0,1-2*bY]]}else{if(b1===0&&bZ===0&&bW===1){bQ=[[1-2*bY,2*b0*bV,0],[-2*b0*bV,1-2*bY,0],[0,0,1]]}else{bO=b1*b1;bX=bZ*bZ;bT=bW*bW;bQ=[[1-2*(bX+bT)*bY,2*(b1*bZ*bY+bW*b0*bV),2*(b1*bW*bY-bZ*b0*bV)],[2*(bZ*b1*bY-bW*b0*bV),1-2*(bT+bO)*bY,2*(bZ*bW*bY+b1*b0*bV)],[2*(bW*b1*bY+bZ*b0*bV),2*(bW*bZ*bY-b1*b0*bV),1-2*(bO+bX)*bY]]}}}return bQ};O=function(bQ,bP,bR,bU,bO){var bS,bT;bT=(bP*bU-bR)/(1-bU);bS=bO*bU/(1-bU);return[bS*bQ[0]/(bQ[2]+bT),bS*bQ[1]/(bQ[2]+bT)]};bp=function(bV,bS,bY,bW,b2,bR,bQ,bP){var b1,bO,bX,bT,bZ,b4,b6,bU,b0,b3,b5;b0=(b2*bQ-bR)/(1-bQ);b1=bP*bQ/(1-bQ);bX=bV-bY;b4=bS-bW;bO=b1*b1;b3=b0*b0;bT=bX*bX;b6=b4*b4;bZ=(2*b1*bX*b0+bo(4*bO*bT*b3+4*bT*(bO+bT+b6)*(1-b3)))/(2*(bO+bT+b6));bU=(b1*b4*b0)/(bO+bT+b6)+(b4*bo(4*bO*b3+4*(bO+bT+b6)*(1-b3)))/(2*(bO+bT+b6));b5=bo(1-bZ*bZ-bU*bU);return[bZ,bU,b5]};bA=function(bQ,bP){var bR,bO;bO=aR(bQ,bP);bR=Y(be(bQ,bP));return at(-1*bR,bO[0],bO[1],bO[2])};v=function(bR){var bP,bT,bS,bQ,bO;bP=[];bT=bR.slice(-1)[0];for(bQ=0,bO=bR.length;bQ<bO;bQ++){bS=bR[bQ];bP.push([bT,bS]);bT=bS}return bP};aN=function(bO){var bU,bT,bX,bV,bR,bQ,bW,bP,bS;bV=[];bS=bO.face;for(bT=bR=0,bW=bS.length;bR<bW;bT=++bR){bU=bS[bT];for(bQ=0,bP=bU.length;bQ<bP;bQ++){bX=bU[bQ];bV[bX]=bO.face_class[bT]}}return bV};ah=["#ff7777","#dddddd","#889999","#fff0e5","#aa3333","#ff0000","#ffffff","#aaaaaa"];ab=function(bP){var bO;if(bP[0]==="#"){bP=bP.slice(1)}if(bP.length===3){bO=bP.split("").map(function(bQ){return parseInt(bQ+bQ,16)/255})}else{bO=bP.match(/.{2}/g).map(function(bQ){return parseInt(bQ,16)/255})}return bO};bb=ah;G=function(bO){if(bO<bb.length){return ab(bb[bO])}else{return ab(bb[bb.length-1])}};av=function(bO){var bX,bP,bT,bS,bV,bW,bQ,bU,bR;bO.face_class=[];bT={};bP=function(bY,b1){var bZ,b0;b0=w(100*bY);if(b0 in b1){return b1[b0]}else{bZ=_.toArray(b1).length;b1[b0]=bZ;return bZ}};bR=bO.face;for(bQ=0,bU=bR.length;bQ<bU;bQ++){bS=bR[bQ];if(br==="area"){bV=(function(){var b0,bZ,bY;bY=[];for(b0=0,bZ=bS.length;b0<bZ;b0++){bW=bS[b0];bY.push(bO.xyz[bW])}return bY})();bX=bP(E(bV),bT)}else{if(br==="signature"){bV=(function(){var b0,bZ,bY;bY=[];for(b0=0,bZ=bS.length;b0<bZ;b0++){bW=bS[b0];bY.push(bO.xyz[bW])}return bY})();bX=bP(aC(bV),bT)}else{bX=bS.length-3}}bO.face_class.push(bX)}console.log(_.toArray(bT).length+" face classes");return bO};aE=function(bO){var bP,bW,bY,bX,bS,bQ,bZ,bV,bT,bU,bR;bP=bO.centers();bX=bO.normals();bW=bO.extents();bS=[0,0,(bq*af-N)/(1-af)];bQ=function(b1,b0){return b1[1][2]-b0[1][2]};bZ=function(b1,b0){return b1[3][2][1]-b0[3][2][1]};bV=_.zip((function(){bR=[];for(var b1=0,b0=bO.face.length-1;0<=b0?b1<=b0:b1>=b0;0<=b0?b1++:b1--){bR.push(b1)}return bR}).apply(this),bP,bX,bW).sort(bQ).map(function(b0){return b0[0]});bO.face=(function(){var b2,b0,b1;b1=[];for(b2=0,b0=bV.length;b2<b0;b2++){bY=bV[b2];b1.push(bO.face[bY])}return b1})();return bO.face_class=(function(){var b2,b0,b1;b1=[];for(b2=0,b0=bV.length;b2<b0;b2++){bY=bV[b2];b1.push(bO.face_class[bY])}return b1})()};aX=function(bU,bT,bQ){var bR,bV,bZ,bW,bO,bY,bS,bP,bX;bV=n(bU);bR=aZ(bU);bW=be(a4(bQ,bR),bV);bO=true;bZ=true;for(bP=0,bX=bT.length;bP<bX;bP++){bS=bT[bP];bY=be(a4(bS,bR),bV)*bW;if(ai(bY)<1e-10){bY=0}if(bY<0){bO=false}if(bY>0){bZ=false}}if(bO){return 1}else{if(bZ){return -1}else{return 0}}};m=function(ca){var b4,ce,cc,cb,cu,cs,cr,bS,b1,b0,bZ,ci,cg,cf,cv,cl,ct,bP,b9,bO,b5,b6,b3,cq,cd,b8,ch,cj,cn,b7,cp,co,b2,ck,bY,bX,bW,bV,bU,bT,bR,bQ,cm;b8=[0,0,(bq*af-N)/(1-af)];b9=ca.centers();bO=ca.extents();cn=function(cx,cw){return cx[1][2][0]-cw[1][2][0]};b5=function(cC,cB){var cA,cw,cx,cE,cD,cz,cy;cz=cC[1][2],cw=cz[0],cA=cz[1];cy=cB[1][2],cE=cy[0],cx=cy[1];cD=cw-cE;if(ai(cD)<1e-10){cD=0}if(cD!==0){return cD}cD=cA-cx;if(ai(cD)<1e-10){cD=0}return cD};b7=_.zip((function(){cm=[];for(var cx=0,cw=ca.face.length-1;0<=cw?cx<=cw:cx>=cw;0<=cw?cx++:cx--){cm.push(cx)}return cm}).apply(this),bO,b9).sort(b5).map(function(cw){return cw[0]});b6=(function(){var cy,cw,cx;cx=[];for(cy=0,cw=b7.length;cy<cw;cy++){cq=b7[cy];cx.push(cq)}return cx})();ch=0;console.log(b6);cd=0;while(ch<b6.length-1&&cd<500){cd+=1;cl=b6[ch];for(b3=co=0,b2=b6.length;co<b2;b3=++co){bP=b6[b3];if(b3<=ch){continue}cv=(function(){var cz,cx,cw,cy;cw=ca.face[cl];cy=[];for(cz=0,cx=cw.length;cz<cx;cz++){cj=cw[cz];cy.push(ca.xyz[cj])}return cy})();ct=(function(){var cz,cx,cw,cy;cw=ca.face[bP];cy=[];for(cz=0,cx=cw.length;cz<cx;cz++){cj=cw[cz];cy.push(ca.xyz[cj])}return cy})();bY=p(cv),(bX=bY[0],cu=bX[0],ce=bX[1]),(bW=bY[1],cs=bW[0],cc=bW[1]),(bV=bY[2],cr=bV[0],cb=bV[1]);bU=p(ct),(bT=bU[0],ci=bT[0],b1=bT[1]),(bR=bU[1],cg=bR[0],b0=bR[1]),(bQ=bU[2],cf=bQ[0],bZ=bQ[1]);if(bZ<cr){console.log("wtf pre-ordering fail",cl,"=",cr,cb," ",bP,"=",cf,bZ)}if(cb<=cf||bZ<=cr){continue}if(ce<=ci||b1<=cu){continue}if(cc<=cg||b0<=cs){continue}b4=aX(cv,ct,b8);bS=aX(ct,cv,b8);if(b4===1||bS===-1){continue}if(bS===1||b4===-1){b6[ch]=bP;b6[b3]=cl;console.log("switch",cl,bP,b4,bS);ch=-1;break}console.log("Warning: All tests failed on ",cl,bP);break}ch+=1}console.log(ch,cd);ca.face=(function(){var cy,cw,cx;cx=[];for(cy=0,cw=b6.length;cy<cw;cy++){cq=b6[cy];cx.push(ca.face[cq])}return cx})();return ca.face_class=(function(){var cy,cw,cx;cx=[];for(cy=0,cw=b6.length;cy<cw;cy++){cq=b6[cy];cx.push(ca.face_class[cq])}return cx})()};aL=function(b3,bZ,bO){var bT,bQ,b0,bY,bX,b5,b4,bU,bS,bW,bR,bP,bV;if(bO==null){bO=false}bT=b3[0],bQ=b3[1];b0=bZ[0],bY=bZ[1];b5=bg(bQ,bT);b4=bg(bY,b0);bX=bN(b5,b4);if(M(bX)===0){if(bN(bg(b0,bT),b5)===0){bW=aD(b5,b5);bR=aD(bg(b0,bT),b5);bP=aD(bg(bY,bT),b5);if(bR>bP){bV=[bP,bR],bR=bV[0],bP=bV[1]}if(bO&&bR===0&&(bP=bW)){return false}if(bP<=0||bR>=bW){return false}else{return true}}else{return false}}bS=M(bN(bg(b0,bT),b5)/bX);bU=M(bN(bg(b0,bT),b4)/bX);if((0<bS&&bS<1)&&(0<bU&&bU<1)){return true}else{return false}};bM=function(b2,b1){var bU,bV,bX,b8,bW,bT,bY,bS,bR,bQ,bP,b3,b6,b5,b4,b0,bZ,bO,b7;bV=_.zip(b2.slice(1),b2.slice(0,+(b2.length-2)+1||9000000000));bV.push([b2[b2.length-1],b2[0]]);bW=_.zip(b1.slice(1),b1.slice(0,+(b1.length-2)+1||9000000000));bW.push([b1[b1.length-1],b1[0]]);for(bS=0,b3=bV.length;bS<b3;bS++){bU=bV[bS];for(bR=0,b6=bW.length;bR<b6;bR++){b8=bW[bR];if(aL(bU,b8,true)){return true}}}for(bQ=0,b5=b2.length;bQ<b5;bQ++){bX=b2[bQ];bY=0;for(bP=0,b4=bW.length;bP<b4;bP++){b8=bW[bP];if(aL(b8,[bX,[10000,0]])){bY+=1}}if(bY%2!==0){return true}}for(bO=0,b0=b1.length;bO<b0;bO++){bT=b1[bO];bY=0;for(b7=0,bZ=bV.length;b7<bZ;b7++){bU=bV[b7];if(aL(bU,[bT,[10000,0]])){bY+=1}}if(bY%2!==0){return true}}return false};au=function(bS,bZ,bW,b4,b1){var b6,b5,bT,b7,b3,bY,b0,bO,bX,bV,bR,b2,bQ,bU,bP;bO=[0,0,(bZ*b4-bW)/(1-b4)];b6=bS.centers();b5=bS.extents();b3=(function(){var cb,b9,ca,b8;ca=bS.face;b8=[];for(cb=0,b9=ca.length;cb<b9;cb++){b7=ca[cb];b8.push((function(){var ce,cc,cd;cd=[];for(ce=0,cc=b7.length;ce<cc;ce++){bV=b7[ce];cd.push(bS.xyz[bV])}return cd})())}return b8})();b0=(function(){var cb,b9,ca,b8;ca=bS.face;b8=[];for(cb=0,b9=ca.length;cb<b9;cb++){b7=ca[cb];b8.push((function(){var ce,cc,cd;cd=[];for(ce=0,cc=b7.length;ce<cc;ce++){bV=b7[ce];cd.push(O(bS.xyz[bV],bZ,bW,b4,b1))}return cd})())}return b8})();M=function(b8){if(ai(b8)<1e-10){return 0}else{return b8}};bT=function(b9,b8){var cb,ce,ca,cc,cd;ce=b9[0],cb=b9[1];cc=b8[0],ca=b8[1];cd=M(ce-cc);if(cd!==0){return cd}cd=M(cb-ca);return cd};b2=_.zip((function(){bP=[];for(var b9=0,b8=bS.face.length-1;0<=b8?b9<=b8:b9>=b8;0<=b8?b9++:b9--){bP.push(b9)}return bP}).apply(this),b5,b6).sort(function(b9,b8){return bT(b9[1][2],b8[1][2])}).map(function(b8){return b8[0]});bR=[];bX=function(b9,cg){var cp,cx,cv,ct,cz,cw,cu,cq,cl,cj,ch,cm,ck,ci,cs,cr,co,cn,cf,ce,cd,cc,cb,ca,b8,cy;cs=b3[b9];cr=b3[cg];cf=ao(cs,bZ,bW,b4,b1),(ce=cf[0],cz=ce[0],cx=ce[1]),(cd=cf[1],cw=cd[0],cv=cd[1]),(cc=cf[2],cu=cc[0],ct=cc[1]);cb=ao(cr,bZ,bW,b4,b1),(ca=cb[0],cm=ca[0],cl=ca[1]),(b8=cb[1],ck=b8[0],cj=b8[1]),(cy=cb[2],ci=cy[0],ch=cy[1]);if(M(ct-ci)<=0||M(ch-cu)<=0){return M(cu-ci)}if(M(cx-cm)<=0||M(cl-cz)<=0){return M(cu-ci)}if(M(cv-ck)<=0||M(cj-cw)<=0){return M(cu-ci)}cp=aX(cs,cr,bO);cq=aX(cr,cs,bO);if(cp===1||cq===-1){return -1}if(cq===1||cp===-1){return 1}co=b0[b9];cn=b0[cg];if(!bM(co,cn)){console.log("no isect",b9,cg);return M(cu-ci)}else{console.log("isect",b9,cg)}bR.push(bS.face[b9]);bR.push(bS.face[cg]);console.log("wtf",b9,cg,cp,cq);return M(cu-ci)};b2.sort(bX);bS.face=(function(){var ca,b8,b9;b9=[];for(ca=0,b8=b2.length;ca<b8;ca++){bY=b2[ca];b9.push(bS.face[bY])}return b9})();bS.face_class=(function(){var ca,b8,b9;b9=[];for(ca=0,b8=b2.length;ca<b8;ca++){bY=b2[ca];b9.push(bS.face_class[bY])}return b9})();return bR};a2=(function(){function bO(bR,bP,bQ){this.face=bP||new Array();this.xyz=bR||new Array();this.name=bQ||"null polyhedron"}bO.prototype.data=function(){var bP;bP=this.face.length+this.xyz.length-2;return"("+this.face.length+" faces, "+bP+" edges, "+this.xyz.length+" vertices)"};bO.prototype.edges=function(){var bZ,bV,bX,bW,bP,bU,bT,b0,bS,bR,bY,bQ;bU={};b0=[];bV=_.map(this.face,v);for(bS=0,bY=bV.length;bS<bY;bS++){bP=bV[bS];for(bR=0,bQ=bP.length;bR<bQ;bR++){bW=bP[bR];if(bW[0]<bW[1]){bZ=bW[0],bX=bW[1]}else{bX=bW[0],bZ=bW[1]}bU[bZ+"~"+bX]=bW}}for(bT in bU){bW=bU[bT];b0.push(bW)}return b0};bO.prototype.centers=function(){var bU,bV,bR,bX,bS,bQ,bW,bP,bT;bU=[];bT=this.face;for(bS=0,bW=bT.length;bS<bW;bS++){bV=bT[bS];bR=[0,0,0];for(bQ=0,bP=bV.length;bQ<bP;bQ++){bX=bV[bQ];bR=P(bR,this.xyz[bX])}bU.push(a(1/bV.length,bR))}return bU};bO.prototype.normals=function(){var bT,bU,bQ,bS,bP,bR;bU=[];bR=this.face;for(bS=0,bP=bR.length;bS<bP;bS++){bT=bR[bS];bU.push(n((function(){var bX,bW,bV;bV=[];for(bX=0,bW=bT.length;bX<bW;bX++){bQ=bT[bX];bV.push(this.xyz[bQ])}return bV}).call(this)))}return bU};bO.prototype.extents=function(){var b2,b3,b7,b5,b1,b8,b6,b4,b0,bZ,bX,bW,bT,bR,b9,ca,bY,bV,bU,bS,bQ,bP;b2=[];bY=this.face;for(bT=0,b9=bY.length;bT<b9;bT++){b3=bY[bT];bV=this.xyz[b3[0]],bZ=bV[0],bX=bV[1],bW=bV[2];bU=[bZ,bZ],b7=bU[0],b8=bU[1];bS=[bX,bX],b5=bS[0],b6=bS[1];bQ=[bW,bW],b1=bQ[0],b4=bQ[1];for(bR=0,ca=b3.length;bR<ca;bR++){b0=b3[bR];bP=this.xyz[b0],bZ=bP[0],bX=bP[1],bW=bP[2];b7=b7<bZ?bZ:b7;b8=b8>bZ?bZ:b8;b5=b5<bX?bX:b5;b6=b6>bX?bX:b6;b1=b1<bW?bW:b1;b4=b4>bW?bW:b4}b2.push([[b8,b7],[b6,b5],[b4,b1]])}return b2};bO.prototype.toOBJ=function(){var b1,b0,bQ,b2,b4,bY,bX,bV,bT,b3,bS,bR,bP,bZ,bW,bU;b2="#Produced by polyHÃ©dronisme http://levskaya.github.com/polyhedronisme\n";b2+="group "+this.name+"\n";b2+="#vertices\n";bZ=this.xyz;for(bY=0,b3=bZ.length;bY<b3;bY++){b4=bZ[bY];b2+="v "+b4[0]+" "+b4[1]+" "+b4[2]+"\n"}b2+="#normal vector defs \n";bW=this.face;for(bX=0,bS=bW.length;bX<bS;bX++){b1=bW[bX];bQ=n((function(){var b7,b5,b6;b6=[];for(b7=0,b5=b1.length;b7<b5;b7++){b4=b1[b7];b6.push(this.xyz[b4])}return b6}).call(this));b2+="vn "+bQ[0]+" "+bQ[1]+" "+bQ[2]+"\n"}b2+="#face defs \n";bU=this.face;for(b0=bV=0,bR=bU.length;bV<bR;b0=++bV){b1=bU[b0];b2+="f ";for(bT=0,bP=b1.length;bT<bP;bT++){b4=b1[bT];b2+=""+(b4+1)+"//"+(b0+1)+" "}b2+="\n"}return b2};bO.prototype.toX3D=function(){var bT,b3,b5,b0,b2,b4,bY,bX,bV,bS,b1,bR,bQ,bP,bZ,bW,bU;bT=0.01;b4='<?xml version="1.0" encoding ="UTF-8"?>\n<X3D profile="Interchange" version="3.0">\n<head>\n<component name="Rendering" level="3"/>\n<meta name="generator" content="Polyhedronisme"/>\n<meta name="version" content="0.1.0"/>\n</head>\n<Scene>\n<Shape>\n<IndexedFaceSet normalPerVertex="false" coordIndex="';bZ=this.face;for(bY=0,b1=bZ.length;bY<b1;bY++){b0=bZ[bY];for(bX=0,bR=b0.length;bX<bR;bX++){b2=b0[bX];b4+=""+b2+" "}b4+="-1\n"}b4+='">\n';b4+='<Color color="';bW=aN(this);for(bV=0,bQ=bW.length;bV<bQ;bV++){b3=bW[bV];b5=G(b3);b4+=""+b5[0]+" "+b5[1]+" "+b5[2]+" "}b4+='"/>';b4+='<Coordinate point="';bU=this.xyz;for(bS=0,bP=bU.length;bS<bP;bS++){b2=bU[bS];b4+=""+(b2[0]*bT)+" "+(b2[1]*bT)+" "+(b2[2]*bT)+" "}b4+='"/>\n';b4+="</IndexedFaceSet>\n</Shape>\n</Scene>\n</X3D>";return b4};bO.prototype.toVRML=function(){var bT,b3,b5,b0,b2,b4,bY,bX,bV,bS,b1,bR,bQ,bP,bZ,bW,bU;bT=0.01;b4='#VRML V2.0 utf8\n#Generated by Polyhedronisme\nNavigationInfo {\n	type [ "EXAMINE", "ANY" ]\n}\nTransform {\n  scale 1 1 1\n  translation 0 0 0\n  children\n  [\n    Shape\n    {\n      geometry IndexedFaceSet\n      {\n        creaseAngle .5\n        solid FALSE\n        coord Coordinate\n        {\n          point\n          [';bZ=this.xyz;for(bY=0,b1=bZ.length;bY<b1;bY++){b2=bZ[bY];b4+=""+(b2[0]*bT)+" "+(b2[1]*bT)+" "+(b2[2]*bT)+","}b4=b4.slice(0,-1);b4+="    ]\n}\ncolor Color\n{\n  color\n  [";bW=this.face_class;for(bX=0,bR=bW.length;bX<bR;bX++){b3=bW[bX];b5=G(b3);b4+=""+b5[0]+" "+b5[1]+" "+b5[2]+" ,"}b4=b4.slice(0,-1);b4+="  ]\n}\ncolorPerVertex FALSE\ncoordIndex\n[";bU=this.face;for(bV=0,bQ=bU.length;bV<bQ;bV++){b0=bU[bV];for(bS=0,bP=b0.length;bS<bP;bS++){b2=b0[bS];b4+=""+b2+", "}b4+="-1,"}b4=b4.slice(0,-1);b4+="          ]\n      }\n      appearance Appearance\n      {\n        material Material\n        {\n	       ambientIntensity 0.2\n	       diffuseColor 0.9 0.9 0.9\n	       specularColor .1 .1 .1\n	       shininess .5\n        }\n      }\n    }\n  ]\n}";return b4};return bO})();ay=function(){var bO;bO=new a2();bO.name="T";bO.face=[[0,1,2],[0,2,3],[0,3,1],[1,3,2]];bO.xyz=[[1,1,1],[1,-1,-1],[-1,1,-1],[-1,-1,1]];return bO};aI=function(){var bO;bO=new a2();bO.name="O";bO.face=[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]];bO.xyz=[[0,0,1.414],[1.414,0,0],[0,1.414,0],[-1.414,0,0],[0,-1.414,0],[0,0,-1.414]];return bO};a1=function(){var bO;bO=new a2();bO.name="C";bO.face=[[3,0,1,2],[3,4,5,0],[0,5,6,1],[1,6,7,2],[2,7,4,3],[5,4,7,6]];bO.xyz=[[0.707,0.707,0.707],[-0.707,0.707,0.707],[-0.707,-0.707,0.707],[0.707,-0.707,0.707],[0.707,-0.707,-0.707],[0.707,0.707,-0.707],[-0.707,0.707,-0.707],[-0.707,-0.707,-0.707]];return bO};C=function(){var bO;bO=new a2();bO.name="I";bO.face=[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]];bO.xyz=[[0,0,1.176],[1.051,0,0.526],[0.324,1,0.525],[-0.851,0.618,0.526],[-0.851,-0.618,0.526],[0.325,-1,0.526],[0.851,0.618,-0.526],[0.851,-0.618,-0.526],[-0.325,1,-0.526],[-1.051,0,-0.526],[-0.325,-1,-0.526],[0,0,-1.176]];return bO};ak=function(){var bO;bO=new a2();bO.name="D";bO.face=[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]];bO.xyz=[[0,0,1.07047],[0.713644,0,0.797878],[-0.356822,0.618,0.797878],[-0.356822,-0.618,0.797878],[0.797878,0.618034,0.356822],[0.797878,-0.618,0.356822],[-0.934172,0.381966,0.356822],[0.136294,1,0.356822],[0.136294,-1,0.356822],[-0.934172,-0.381966,0.356822],[0.934172,0.381966,-0.356822],[0.934172,-0.381966,-0.356822],[-0.797878,0.618,-0.356822],[-0.136294,1,-0.356822],[-0.136294,-1,-0.356822],[-0.797878,-0.618034,-0.356822],[0.356822,0.618,-0.797878],[0.356822,-0.618,-0.797878],[-0.713644,0,-0.797878],[0,0,-1.07047]];return bO};f=function(bS){var b4,b3,bO,bP,b1,b0,bW,bU,bR,b2,bZ,bV,bT,bQ,bY,bX;bP=2*aa/bS;b4=Math.sin(bP/2);bO=new a2();bO.name="P"+bS;for(b3=b1=0,b2=bS-1;0<=b2?b1<=b2:b1>=b2;b3=0<=b2?++b1:--b1){bO.xyz.push([-W(b3*bP),-aQ(b3*bP),-b4])}for(b3=b0=0,bZ=bS-1;0<=bZ?b0<=bZ:b0>=bZ;b3=0<=bZ?++b0:--b0){bO.xyz.push([-W(b3*bP),-aQ(b3*bP),b4])}bO.face.push((function(){bY=[];for(var b5=bV=bS-1;bV<=0?b5<=0:b5>=0;bV<=0?b5++:b5--){bY.push(b5)}return bY}).apply(this));bO.face.push((function(){bX=[];for(var b5=bS,b6=2*bS-1;bS<=b6?b5<=b6:b5>=b6;bS<=b6?b5++:b5--){bX.push(b5)}return bX}).apply(this));for(b3=bR=0,bQ=bS-1;0<=bQ?bR<=bQ:bR>=bQ;b3=0<=bQ?++bR:--bR){bO.face.push([b3,(b3+1)%bS,(b3+1)%bS+bS,b3+bS])}bO=bE(bO,1);return bO};u=function(b3){var b6,b5,b4,bY,b2,b0,bU,bR,bQ,bP,bO,b1,bX,bW,bV,bS,bT,bZ;b0=2*aa/b3;b5=bo(1-4/(4+2*W(b0/2)-2*W(b0)));b2=bo(1-b5*b5);b6=bo(b5*b5+aU(b2*W(b0/2),2));b2=-b2/b6;b5=-b5/b6;bY=new a2();bY.name="A"+b3;for(b4=bU=0,b1=b3-1;0<=b1?bU<=b1:bU>=b1;b4=0<=b1?++bU:--bU){bY.xyz.push([b2*W(b4*b0),b2*aQ(b4*b0),b5])}for(b4=bR=0,bX=b3-1;0<=bX?bR<=bX:bR>=bX;b4=0<=bX?++bR:--bR){bY.xyz.push([b2*W((b4+0.5)*b0),b2*aQ((b4+0.5)*b0),-b5])}bY.face.push((function(){bT=[];for(var b7=bW=b3-1;bW<=0?b7<=0:b7>=0;bW<=0?b7++:b7--){bT.push(b7)}return bT}).apply(this));bY.face.push((function(){bZ=[];for(var b7=b3,b8=2*b3-1;b3<=b8?b7<=b8:b7>=b8;b3<=b8?b7++:b7--){bZ.push(b7)}return bZ}).apply(this));for(b4=bO=0,bS=b3-1;0<=bS?bO<=bS:bO>=bS;b4=0<=bS?++bO:--bO){bY.face.push([b4,(b4+1)%b3,b4+b3]);bY.face.push([b4,b4+b3,(b3+b4-1)%b3+b3])}bY=bE(bY,1);return bY};U=function(bQ){var bZ,bY,bO,bP,bW,bV,bS,bX,bU,bR,bT;bP=2*aa/bQ;bZ=1;bO=new a2();bO.name="Y"+bQ;for(bY=bW=0,bX=bQ-1;0<=bX?bW<=bX:bW>=bX;bY=0<=bX?++bW:--bW){bO.xyz.push([-W(bY*bP),-aQ(bY*bP),-0.2])}bO.xyz.push([0,0,bZ]);bO.face.push((function(){bT=[];for(var b0=bU=bQ-1;bU<=0?b0<=0:b0>=0;bU<=0?b0++:b0--){bT.push(b0)}return bT}).apply(this));for(bY=bS=0,bR=bQ-1;0<=bR?bS<=bR:bS>=bR;bY=0<=bR?++bS:--bS){bO.face.push([bY,(bY+1)%bQ,bQ])}bO=by(bO,3);return bO};bt=(function(){function bO(){this.flags=new Object();this.verts=new Object();this.xyzs=new Object()}bO.prototype.newV=function(bQ,bP){if(this.verts[bQ]===void 0){this.verts[bQ]=0;return this.xyzs[bQ]=bP}};bO.prototype.newFlag=function(bP,bR,bQ){if(this.flags[bP]===void 0){this.flags[bP]={}}return this.flags[bP][bR]=bQ};bO.prototype.topoly=function(){var bQ,bV,bY,bU,bS,bP,bW,bX,bT,bR;bP=new a2();bQ=0;bT=this.verts;for(bU in bT){bW=bT[bU];bP.xyz[bQ]=this.xyzs[bU];this.verts[bU]=bQ;bQ++}bQ=0;bR=this.flags;for(bU in bR){bV=bR[bU];bP.face[bQ]=[];for(bS in bV){bW=bV[bS];bX=bW;break}bW=bX;bP.face[bQ].push(this.verts[bW]);bW=this.flags[bU][bW];bY=0;while(bW!==bX){bP.face[bQ].push(this.verts[bW]);bW=this.flags[bU][bW];bY++;if(bY>1000){console.log("Bad flag spec, have a neverending face:",bU,this.flags[bU]);break}}bQ++}bP.name="unknown polyhedron";return bP};return bO})();J=function(bX,b3,bW){var bV,b7,b6,b4,b9,bU,b5,bZ,b1,b2,b0,bS,bQ,bR,bP,bO,b8,cb,ca,bY,bT;b3||(b3=0);bW||(bW=0.1);console.log("Taking kis of "+(b3===0?"":b3)+"-sided faces of "+bX.name+"...");b4=new bt();bY=bX.xyz;for(b5=bR=0,b8=bY.length;bR<b8;b5=++bR){b2=bY[b5];b4.newV("v"+b5,b2)}b1=bX.normals();b7=bX.centers();bU=false;bT=bX.face;for(b5=bP=0,cb=bT.length;bP<cb;b5=++bP){b6=bT[b5];bS="v"+b6[b6.length-1];for(bO=0,ca=b6.length;bO<ca;bO++){b0=b6[bO];bQ="v"+b0;if(b6.length===b3||b3===0){bU=true;bV="apex"+b5;b9=""+b5+bS;b4.newV(bV,P(b7[b5],a(bW,b1[b5])));b4.newFlag(b9,bS,bQ);b4.newFlag(b9,bQ,bV);b4.newFlag(b9,bV,bS)}else{b4.newFlag(""+b5,bS,bQ)}bS=bQ}}if(!bU){console.log("No "+b3+"-fold components were found.")}bZ=b4.topoly();bZ.name="k"+(b3===0?"":b3)+bX.name;return bZ};T=function(bO){var bY,bZ,bX,bP,bS,b3,b2,b0,bV,bU,b1,bQ,bW,bT,bR;console.log("Taking ambo of "+bO.name+"...");bP=function(b5,b4){if(b5<b4){return b5+"_"+b4}else{return b4+"_"+b5}};bZ=new bt();bW=bO.face;for(bX=bV=0,b1=bW.length;bV<b1;bX=++bV){bY=bW[bX];bT=bY.slice(-2),b3=bT[0],b2=bT[1];for(bU=0,bQ=bY.length;bU<bQ;bU++){b0=bY[bU];if(b3<b2){bZ.newV(bP(b3,b2),bL(bO.xyz[b3],bO.xyz[b2]))}bZ.newFlag("orig"+bX,bP(b3,b2),bP(b2,b0));bZ.newFlag("dual"+b2,bP(b2,b0),bP(b3,b2));bR=[b2,b0],b3=bR[0],b2=bR[1]}}bS=bZ.topoly();bS.name="a"+bO.name;return bS};D=function(bZ){var b7,b6,b4,ca,b5,b3,b1,b2,bX,bU,bR,bV,bS,bP,bO,b9,cc,cb,b8,b0,bY,bW,bT,bQ;console.log("Taking gyro of "+bZ.name+"...");b4=new bt();b0=bZ.xyz;for(b5=bV=0,b9=b0.length;bV<b9;b5=++bV){b2=b0[b5];b4.newV("v"+b5,az(b2))}b7=bZ.centers();bY=bZ.face;for(b5=bS=0,cc=bY.length;bS<cc;b5=++bS){b6=bY[b5];b4.newV("center"+b5,az(b7[b5]))}bW=bZ.face;for(b5=bP=0,cb=bW.length;bP<cb;b5=++bP){b6=bW[b5];bT=b6.slice(-2),bX=bT[0],bU=bT[1];for(b3=bO=0,b8=b6.length;bO<b8;b3=++bO){b2=b6[b3];bR=b2;b4.newV(bX+"~"+bU,bv(bZ.xyz[bX],bZ.xyz[bU]));ca=b5+"f"+bX;b4.newFlag(ca,"center"+b5,bX+"~"+bU);b4.newFlag(ca,bX+"~"+bU,bU+"~"+bX);b4.newFlag(ca,bU+"~"+bX,"v"+bU);b4.newFlag(ca,"v"+bU,bU+"~"+bR);b4.newFlag(ca,bU+"~"+bR,"center"+b5);bQ=[bU,bR],bX=bQ[0],bU=bQ[1]}}b1=b4.topoly();b1.name="g"+bZ.name;return b1};bi=function(bX){var b3,b1,b5,b2,bZ,b0,bV,bS,bP,bT,bQ,bO,b4,b7,b6,bY,bW,bU,bR;console.log("Taking propellor of "+bX.name+"...");b1=new bt();bY=bX.xyz;for(b2=bT=0,b4=bY.length;bT<b4;b2=++bT){b0=bY[b2];b1.newV("v"+b2,az(b0))}bW=bX.face;for(b2=bQ=0,b7=bW.length;bQ<b7;b2=++bQ){b3=bW[b2];bU=b3.slice(-2),bV=bU[0],bS=bU[1];for(bO=0,b6=b3.length;bO<b6;bO++){b0=b3[bO];bP=""+b0;b1.newV(bV+"~"+bS,bv(bX.xyz[bV],bX.xyz[bS]));b5=""+b2+"f"+bS;b1.newFlag("v"+b2,bV+"~"+bS,bS+"~"+bP);b1.newFlag(b5,bV+"~"+bS,bS+"~"+bV);b1.newFlag(b5,bS+"~"+bV,"v"+bS);b1.newFlag(b5,"v"+bS,bS+"~"+bP);b1.newFlag(b5,bS+"~"+bP,bV+"~"+bS);bR=[bS,bP],bV=bR[0],bS=bR[1]}}bZ=b1.topoly();bZ.name="p"+bX.name;return bZ};ae=function(bT){var bP,bS,bQ,bR,bO;console.log("Taking reflection of "+bT.name+"...");for(bP=bS=0,bR=bT.xyz.length-1;0<=bR?bS<=bR:bS>=bR;bP=0<=bR?++bS:--bS){bT.xyz[bP]=a(-1,bT.xyz[bP])}for(bP=bQ=0,bO=bT.face.length-1;0<=bO?bQ<=bO:bQ>=bO;bP=0<=bO?++bQ:--bQ){bT.face[bP]=bT.face[bP].reverse()}bT.name="r"+bT.name;return bT};bH=function(bZ){var b7,cd,b6,b0,b4,b5,b3,b2,bX,bU,bV,bS,bQ,bP,ca,ce,cb,b9,b8,bO,cf,cc,b1,bY,bW,bT,bR;console.log("Taking dual of "+bZ.name+"...");b4=new bt();b0=[];for(b5=bV=0,b1=bZ.xyz.length-1;0<=b1?bV<=b1:bV>=b1;b5=0<=b1?++bV:--bV){b0[b5]={}}bY=bZ.face;for(b5=bS=0,ca=bY.length;bS<ca;b5=++bS){b6=bY[b5];bX=b6[b6.length-1];for(bQ=0,ce=b6.length;bQ<ce;bQ++){bU=b6[bQ];b0[bX]["v"+bU]=""+b5;bX=bU}}b7=bZ.centers();for(b5=bP=0,bW=bZ.face.length-1;0<=bW?bP<=bW:bP>=bW;b5=0<=bW?++bP:--bP){b4.newV(""+b5,b7[b5])}bT=bZ.face;for(b5=bO=0,cb=bT.length;bO<cb;b5=++bO){b6=bT[b5];bX=b6[b6.length-1];for(cf=0,b9=b6.length;cf<b9;cf++){bU=b6[cf];b4.newFlag(bX,b0[bU]["v"+bX],""+b5);bX=bU}}cd=b4.topoly();b2=[];bR=cd.face;for(cc=0,b8=bR.length;cc<b8;cc++){b6=bR[cc];b3=a7(bZ.face[b6[0]],bZ.face[b6[1]],bZ.face[b6[2]]);b2[b3]=b6}cd.face=b2;if(bZ.name[0]!=="d"){cd.name="d"+bZ.name}else{cd.name=bZ.name.slice(1)}return cd};bD=function(bY,b5,bZ,b6){var ca,b9,b7,ce,bX,b8,b1,b3,b4,b2,bV,bS,bT,bR,bQ,bP,cd,cg,cf,cc,cb,bO,b0,bW,bU;b5||(b5=0);bZ||(bZ=0.5);b6||(b6=-0.2);console.log("Taking inset of "+(b5===0?"":b5)+"-sided faces of "+bY.name+"...");b7=new bt();b0=bY.xyz;for(b8=bT=0,cd=b0.length;bT<cd;b8=++bT){b4=b0[b8];b7.newV("v"+b8,b4)}b3=bY.normals();ca=bY.centers();bW=bY.face;for(b8=bR=0,cg=bW.length;bR<cg;b8=++bR){b9=bW[b8];if(b9.length===b5||b5===0){for(bQ=0,cf=b9.length;bQ<cf;bQ++){b2=b9[bQ];b7.newV("f"+b8+"v"+b2,P(B(bY.xyz[b2],ca[b8],bZ),a(b6,b3[b8])))}}}bX=false;bU=bY.face;for(b8=bP=0,cc=bU.length;bP<cc;b8=++bP){b9=bU[b8];bV="v"+b9[b9.length-1];for(bO=0,cb=b9.length;bO<cb;bO++){b2=b9[bO];bS="v"+b2;if(b9.length===b5||b5===0){bX=true;ce=b8+bV;b7.newFlag(ce,bV,bS);b7.newFlag(ce,bS,"f"+b8+bS);b7.newFlag(ce,"f"+b8+bS,"f"+b8+bV);b7.newFlag(ce,"f"+b8+bV,bV);b7.newFlag("ex"+b8,"f"+b8+bV,"f"+b8+bS)}else{b7.newFlag(b8,bV,bS)}bV=bS}}if(!bX){console.log("No "+b5+"-fold components were found.")}b1=b7.topoly();b1.name="n"+(b5===0?"":b5)+bY.name;return b1};aH=function(bZ,b6,b0,bP){var cb,b9,ca,b7,cf,bY,b8,b2,b4,b5,b3,bW,bU,bT,bS,bR,bQ,ce,ch,cg,cd,cc,bO,b1,bX,bV;b6||(b6=0);b0||(b0=0.5);bP||(bP=0.2);console.log("Skeletonizing "+(b6===0?"":b6)+"-sided faces of "+bZ.name+"...");b9=bH(bZ).normals();b4=bZ.normals();cb=bZ.centers();b7=new bt();b1=bZ.xyz;for(b8=bT=0,ce=b1.length;bT<ce;b8=++bT){b5=b1[b8];b7.newV("v"+b8,b5);b7.newV("downv"+b8,P(b5,a(-1*bP,b9[b8])))}bX=bZ.face;for(b8=bS=0,ch=bX.length;bS<ch;b8=++bS){ca=bX[b8];for(bR=0,cg=ca.length;bR<cg;bR++){b3=ca[bR];b7.newV("fin"+b8+"v"+b3,B(bZ.xyz[b3],cb[b8],b0))}}bV=bZ.face;for(b8=bQ=0,cd=bV.length;bQ<cd;b8=++bQ){ca=bV[b8];bW="v"+ca[ca.length-1];for(bO=0,cc=ca.length;bO<cc;bO++){b3=ca[bO];bU="v"+b3;bY=true;cf=b8+bW;b7.newFlag(cf,bW,bU);b7.newFlag(cf,bU,"fin"+b8+bU);b7.newFlag(cf,"fin"+b8+bU,"fin"+b8+bW);b7.newFlag(cf,"fin"+b8+bW,bW);cf="sides"+b8+bW;b7.newFlag(cf,"down"+bU,"down"+bW);b7.newFlag(cf,"down"+bW,"fin"+b8+bW);b7.newFlag(cf,"fin"+b8+bW,"fin"+b8+bU);b7.newFlag(cf,"fin"+b8+bU,"down"+bU);bW=bU}}b2=b7.topoly();b2.name="h"+bZ.name;return b2};an=function(bY,b4){var b8,b7,b5,bX,b6,b0,b2,b3,b1,bV,bS,bT,bR,bQ,bP,cb,cd,cc,ca,b9,bO,bZ,bW,bU;b4||(b4=0);console.log("Taking extrusion of "+(b4===0?"":b4)+"-sided faces of "+bY.name+"...");b5=new bt();bZ=bY.xyz;for(b6=bT=0,cb=bZ.length;bT<cb;b6=++bT){b3=bZ[b6];b5.newV("v"+b6,b3)}b2=bY.normals();b8=bY.centers();bW=bY.face;for(b6=bR=0,cd=bW.length;bR<cd;b6=++bR){b7=bW[b6];if(b7.length===b4||b4===0){for(bQ=0,cc=b7.length;bQ<cc;bQ++){b1=b7[bQ];b5.newV("f"+b6+"v"+b1,P(bY.xyz[b1],a(0.3,b2[b6])))}}}bX=false;bU=bY.face;for(b6=bP=0,ca=bU.length;bP<ca;b6=++bP){b7=bU[b6];bV="v"+b7[b7.length-1];for(bO=0,b9=b7.length;bO<b9;bO++){b1=b7[bO];bS="v"+b1;if(b7.length===b4||b4===0){bX=true;b5.newFlag(b6+bV,bV,bS);b5.newFlag(b6+bV,bS,"f"+b6+bS);b5.newFlag(b6+bV,"f"+b6+bS,"f"+b6+bV);b5.newFlag(b6+bV,"f"+b6+bV,bV);b5.newFlag("ex"+b6,"f"+b6+bV,"f"+b6+bS)}else{b5.newFlag(b6,bV,bS)}bV=bS}}if(!bX){console.log("No "+b4+"-fold components were found.")}b0=b5.topoly();b0.name="x"+(b4===0?"":b4)+bY.name;return b0};s=function(bZ){var ca,b9,b7,b8,b4,b6,b5,bV,cb,bT,bY,bX,bQ,b2,b1,b0,bS,bP,bO,cc,ce,cd,b3,bW,bU,bR;console.log("Taking stella of "+bZ.name+"...");ca=bZ.centers();b7=new bt();b3=bZ.xyz;for(b8=bS=0,cc=b3.length;bS<cc;b8=++bS){b6=b3[b8];b7.newV("v"+b8,b6)}bW=bZ.face;for(b8=bP=0,ce=bW.length;bP<ce;b8=++bP){b9=bW[b8];bV="v"+b9[b9.length-2];bT="v"+b9[b9.length-1];b2=bZ.xyz[b9[b9.length-2]];b1=bZ.xyz[b9[b9.length-1]];for(bO=0,cd=b9.length;bO<cd;bO++){b5=b9[bO];bQ="v"+b5;b0=bZ.xyz[b5];cb=bV+"~"+bT;bY=bT+"~"+bV;bX=bT+"~"+bQ;b7.newV(cb,bL(bL(b2,b1),ca[b8]));b7.newFlag("in"+b8,cb,bX);b7.newFlag("f"+b8+bT,bX,cb);b7.newFlag("f"+b8+bT,cb,bT);b7.newFlag("f"+b8+bT,bT,bX);b7.newFlag("f"+cb,bV,bY);b7.newFlag("f"+cb,bY,cb);b7.newFlag("f"+cb,cb,bV);bU=[bT,bQ],bV=bU[0],bT=bU[1];bR=[b1,b0],b2=bR[0],b1=bR[1]}}b4=b7.topoly();b4.name="l"+bZ.name;return b4};b=function(bR,bQ){var bV,bT,bS,bO,bW,bP,bU;bV=0.1;bO=a5(bR);for(bP=0,bU=bQ.length;bP<bU;bP++){bS=bQ[bP];bW=aF(bO[bS[0]],bO[bS[1]]);bT=a(bV*1/2*(1-bo(be(bW,bW))),bW);bO[bS[0]]=P(bO[bS[0]],bT);bO[bS[1]]=P(bO[bS[1]],bT)}return bO};ag=function(bS,bR){var bV,bT,bO,bP,bW,bQ,bU;bO=(function(){var b0,bY,bZ,bX;bX=[];for(b0=0,bY=bR.length;b0<bY;b0++){bZ=bR[b0],bV=bZ[0],bT=bZ[1];bX.push(aF(bS[bV],bS[bT]))}return bX})();bP=[0,0,0];for(bQ=0,bU=bO.length;bQ<bU;bQ++){bW=bO[bQ];bP=P(bP,bW)}bP=a(1/bR.length,bP);return _.map(bS,function(bX){return a4(bX,bP)})};i=function(bR){var bO,bQ,bP;bQ=[0,0,0];bO=_.max(_.map(bR,function(bS){return aj(bS)}));bP=1/bO;return _.map(bR,function(bS){return[bP*bS[0],bP*bS[1],bP*bS[2]]})};bB=function(bU,bR){var bZ,bW,bY,bV,bQ,bO,b0,bT,bS,bX,bP;bZ=0.1;bO=a5(bU);for(bT=0,bX=bR.length;bT<bX;bT++){bV=bR[bT];bY=(function(){var b3,b2,b1;b1=[];for(b3=0,b2=bV.length;b3<b2;b3++){b0=bV[b3];b1.push(bU[b0])}return b1})();bQ=n(bY);bW=aZ(bY);if(be(bQ,bW)<0){bQ=a(-1,bQ)}for(bS=0,bP=bV.length;bS<bP;bS++){b0=bV[bS];bO[b0]=P(bO[b0],a(be(a(bZ,bQ),a4(bW,bU[b0])),bQ))}}return bO};aB=function(bP,bW){var bT,bQ,bU,bV,bO,bR,bX,bS;bW||(bW=1);console.log("Canonicalizing "+bP.name+"...");bQ=bP.face;bT=bP.edges();bO=bP.xyz;bV=1;for(bU=bS=0;0<=bW?bS<=bW:bS>=bW;bU=0<=bW?++bS:--bS){bX=a5(bO);bO=b(bO,bT);bO=ag(bO,bT);bO=bB(bO,bQ);bV=_.max(_.map(_.zip(bO,bX),function(bZ){var bY,b0;bY=bZ[0],b0=bZ[1];return aj(a4(bY,b0))}));if(bV<1e-8){break}}console.log("[canonicalization done, last |deltaV|="+bV+"]");bR=new a2(bO,bP.face,bP.name);console.log("canonicalize",bR);return bR};ac=function(bR){var bS,bP,bQ,bO;bP=bR.centers();for(bQ=0,bO=bP.length;bQ<bO;bQ++){bS=bP[bQ];bS=a(1/be(bS,bS),bS)}return bP};X=function(bP){var b4,bY,bR,bZ,bO,bX,b3,b2,b0,bV,bU,b1,bQ,bW,bT,bS;b4=[];bW=bP.face;for(bV=0,b1=bW.length;bV<b1;bV++){bZ=bW[bV];bR=[0,0,0];bO=[0,0,0];bY=0;bT=bZ.slice(-2),b3=bT[0],b2=bT[1];for(bU=0,bQ=bZ.length;bU<bQ;bU++){b0=bZ[bU];bR=P(bR,bP.xyz[b0]);bO=P(bO,y(bP.xyz[b3],bP.xyz[b2],bP.xyz[b0]));bY+=bs(bP.xyz[b3],bP.xyz[b2]);bS=[b2,b0],b3=bS[0],b2=bS[1]}bR=a(1/bZ.length,bR);bO=az(bO);bY=bY/bZ.length;bX=bx(a(be(bR,bO),bO));b4.push(a((1+bY)/2,bX))}return b4};by=function(bT,bP){var bQ,bO,bS,bR;bP||(bP=1);bO=bH(bT);console.log("Pseudo-canonicalizing "+bT.name+"...");for(bQ=bS=0,bR=bP-1;0<=bR?bS<=bR:bS>=bR;bQ=0<=bR?++bS:--bS){bO.xyz=X(bT);bT.xyz=X(bO)}return new a2(bT.xyz,bT.face,bT.name)};bE=function(bT,bP){var bQ,bO,bS,bR;bP||(bP=1);bO=bH(bT);console.log("Planarizing "+bT.name+"...");for(bQ=bS=0,bR=bP-1;0<=bR?bS<=bR:bS>=bR;bQ=0<=bR?++bS:--bS){bO.xyz=ac(bT);bT.xyz=ac(bO)}return new a2(bT.xyz,bT.face,bT.name)};am=function(cg){var cf,cb,b6,b9,ce,bY,ch,b8,b4,b0,cd,bU,ca,b5,bW,bX,bZ,b7,cc,bV,bT,bS,bP,bO,b3,b1,bR,b2,bQ;bZ=999;ca=[];b5=[];bW=cg.length;cd=function(ci,cj){return(ci||cj)&&!(ci&&cj)};cf=function(ck,cj,ci){return(cj[0]-ck[0])*(ci[1]-ck[1])-(ci[0]-ck[0])*(cj[1]-ck[1])};b4=function(ck,cj,ci){return cf(ck,cj,ci)>0};b0=function(ck,cj,ci){return cf(ck,cj,ci)>=0};b6=function(ck,cj,ci){return cf(ck,cj,ci)===0};cb=function(ck,cj,ci){if(b6(ck,cj,ci)){return false}if(ck[0]!==cj[0]){return(ck[0]<=ci[0])&&(ci[0]<=cj[0])||(ck[0]>=ci[0])&&(ci[0]>=cj[0])}else{return(ck[1]<=ci[1])&&(ci[1]<=cj[1])||(ck[1]>=ci[1])&&(ci[1]>=cj[1])}};b8=function(cl,ck,cj,ci){if(b6(cl,ck,cj)||b6(cl,ck,ci)||b6(cj,ci,cl)||b6(cj,ci,ck)){return false}return cd(b4(cl,ck,cj),b4(cl,ck,ci))&&cd(b4(cj,ci,cl),b4(cj,ci,ck))};ch=function(cl,ck,cj,ci){if(b8(cl,ck,cj,ci)){return true}else{if(cb(cl,ck,cj)||cb(cl,ck,ci)||cb(cj,ci,cl)||cb(cj,ci,ck)){return true}else{return false}}};bY=function(ck,ci){var cl,cj;cj=(ck+1+bW)%bW;cl=(ck-1+bW)%bW;if(b0(cg[ck],cg[cj],cg[cl])){return b4(cg[ck],cg[ci],cg[cl])&&b4(cg[ci],cg[ck],cg[cj])}return !(b0(cg[ck],cg[ci],cg[cj])&&b0(cg[ci],cg[ck],cg[cl]))};ce=function(cj,ci){var cl,ck;cl=0;while(true){ck=(cl+1+bW)%bW;if((cl!==cj)&&(ck!==cj)&&(cl!==ci)&&(ck!==ci)&&b8(cg[cj],cg[ci],cg[cl],cg[ck])){return false}cl=(cl+1+bW)%bW;if(cl===0){break}}return true};b9=function(cj,ci){return bY(cj,ci)&&bY(ci,cj)&&ce(cj,ci)};bT=0;while(true){bS=(bT+1+bW)%bW;bV=(bT-1+bW)%bW;b5[bT]=b9(bV,bS);bT=(bT+1+bW)%bW;if(bT===0){break}}cc=(function(){bQ=[];for(var cj=0,ci=bW-1;0<=ci?cj<=ci:cj>=ci;0<=ci?cj++:cj--){bQ.push(cj)}return bQ}).apply(this);b7=bW;b1=bZ;bX=0;while(b1>0&&b7>3){b1-=1;bS=bX;b3=bZ;while(true){b3-=1;bU=false;if(b5[bS]){bP=(bS+1+bW)%bW;bO=(bP+1+bW)%bW;bT=(bS-1+bW)%bW;bV=(bT-1+bW)%bW;ca.push([cc[bT],cc[bP]]);b5[bT]=b9(bV,bP);b5[bP]=b9(bT,bO);cg=cg.slice(0,+bS+1||9000000000).concat(cg.slice(bP));cc=cc.slice(0,+bS+1||9000000000).concat(cc.slice(bP));if(bV>bS){bV-=1}if(bT>bS){bT-=1}if(bP>bS){bP-=1}if(bO>bS){bO-=1}bW--;bX=bP;b7--;bU=true}bS=(bS+1+bW)%bW;if(!(b3>0&&!bU&&bS!==bX)){break}}}return ca};aO=function(bP,bO){if(((bP[0]===bO[0])&&(bP[1]===bO[1])&&(bP[2]===bO[2]))||(bP[0]===bO[1])&&(bP[1]===bO[2])&&(bP[2]===bO[0])||(bP[0]===bO[2])&&(bP[1]===bO[0])&&(bP[2]===bO[1])){return true}else{return false}};bn=function(cl,b8){var b5,cm,b7,b6,b3,b9,cj,bO,bY,cn,cq,cp,co,ck,ci,ch,cg,b4,bW,bV,bU,bT,bS,bR,bQ,bP,cf,ce,cd,cc,cb,ca,b2,b1,b0,bZ,bX;b3=[];bO=[];ca=(function(){var cs,ct,cr;cr=[];for(cj=cs=0,ct=cl.length-1;0<=ct?cs<=ct:cs>=ct;cj=0<=ct?++cs:--cs){cr.push([cj,(cj+1)%cl.length])}return cr})();for(ck=0,b4=ca.length;ck<b4;ck++){b2=ca[ck],cp=b2[0],co=b2[1];b3[cp]=[co];bO[co]=[cp]}for(ci=0,bW=b8.length;ci<bW;ci++){cm=b8[ci];b3[cm[0]].push(cm[1]);b3[cm[1]].push(cm[0]);bO[cm[0]].push(cm[1]);bO[cm[1]].push(cm[0])}cn=[];for(ch=0,bV=b8.length;ch<bV;ch++){cm=b8[ch];b1=b3[cm[1]];for(cg=0,bU=b1.length;cg<bU;cg++){b7=b1[cg];b0=bO[cm[0]];for(cf=0,bT=b0.length;cf<bT;cf++){b6=b0[cf];if(b7===b6){cn.push([cm[0],cm[1],b7])}}}bZ=b3[cm[0]];for(ce=0,bS=bZ.length;ce<bS;ce++){b7=bZ[ce];bX=bO[cm[1]];for(cd=0,bR=bX.length;cd<bR;cd++){b6=bX[cd];if(b7===b6){cn.push([cm[1],cm[0],b7])}}}}cq=[cn.pop()];for(cc=0,bQ=cn.length;cc<bQ;cc++){bY=cn[cc];b5=false;for(cb=0,bP=cq.length;cb<bP;cb++){b9=cq[cb];if(aO(bY,b9)){b5=true;break}}if(!b5){cq.push(bY)}}return cq};o=function(bP,bO){var bS,bR,bZ,bY,bW,bT,b3,b2,b1,bV,bU,b0,bQ,bX;bO=bO||false;console.log("Triangulating faces of "+bP.name+"...");bT=new a2();bT.xyz=bh(bP.xyz);bT.face_class=[];bX=bP.face;for(bY=bV=0,b0=bX.length;bV<b0;bY=++bV){bZ=bX[bY];if(bZ.length>3){bS=aV((function(){var b6,b5,b4;b4=[];for(b6=0,b5=bZ.length;b6<b5;b6++){b1=bZ[b6];b4.push(bP.xyz[b1])}return b4})());bR=am(bS);b2=bn(bZ,bR);for(bW=bU=0,bQ=b2.length;bU<bQ;bW=++bU){b3=b2[bW];bT.face.push([bZ[b3[0]],bZ[b3[1]],bZ[b3[2]]]);if(bO){bT.face_class.push(bP.face_class[bY])}}}else{bT.face.push([bZ[0],bZ[1],bZ[2]]);if(bO){bT.face_class.push(bP.face_class[bY])}}}bT.name=bP.name;return bT};I=function(bO){var bT,bU,bW,bR,bQ,bV,bP,bS;bU="";bS=bO.face;for(bR=0,bV=bS.length;bR<bV;bR++){bT=bS[bR];for(bQ=0,bP=bT.length;bQ<bP;bQ++){bW=bT[bQ];bU+=""+bW+"->"}bU+="\n"}return console.log(bU)};S=function(){var bV,bS,bR,bQ,bU,bT,bP,bO;bQ=["T","O","C","I","D","P3","P4","A4","A5","Y3","Y4"];bS=["k","a","g","p","d","n","x","*"];console.log("===== Test Basic Ops =====");for(bU=0,bP=bS.length;bU<bP;bU++){bV=bS[bU];console.log("Operator "+bV);for(bT=0,bO=bQ.length;bT<bO;bT++){bR=bQ[bT];console.log(bV+bR+":",generatePoly(bV+bR))}}return console.log("===== Done Testing Basic Ops =====")};aP='/* series of opspecs */\nstart  = opspec+\n\n/* opspec one of:\n A  - single letter\n A3 - single letter and float\n B(5,4.3,3) - function call format w. float args\n*/\nopspec =\n   let:opcode args:opargs {return {"op":let,"args":args};}\n/ let:opcode float:float     {return {"op":let,"args":[float]};}\n/ let:opcode                     {return {"op":let,"args":[]};}\n\n/*\nparentheses surrounding comma-delimited list of floats i.e.\n( 1 , 3.2, 4 ) or (1) or (2,3)\n*/\nopargs = "("\n           num:( float:float ","? {return float} )+\n         ")" {return num;}\n\n/* just a letter */\nopcode = op:[a-zA-Z] {return op;}\n\n/* standard numerical types */\nint   = digits:[0-9-]+   { return parseInt(digits.join(""), 10);  }\nfloat = digits:[0-9.-]+  { return parseFloat(digits.join(""), 10); }';bu=PEG.buildParser(aP);al=function(bP,bO){return bP.apply(this,bO||[])};aJ={T:ay,O:aI,C:a1,I:C,D:ak,P:f,A:u,Y:U};Z={d:bH,k:J,a:T,g:D,p:bi,r:ae,n:bD,x:an,l:s,z:o,h:aH,K:by,C:aB,A:bE};F=[[/e/g,"aa"],[/b/g,"ta"],[/o/g,"jj"],[/m/g,"kj"],[/t(\d*)/g,"dk$1d"],[/j/g,"dad"],[/s/g,"dgd"],[/dd/g,""],[/ad/g,"a"],[/gd/g,"g"],[/aO/g,"aC"],[/aI/g,"aD"],[/gO/g,"gC"],[/gI/g,"gD"]];aG=function(bR){var bO,bQ,bU,bT,bP,bS;bQ=bR;for(bT=0,bP=F.length;bT<bP;bT++){bS=F[bT],bU=bS[0],bO=bS[1];bQ=bQ.replace(bU,bO)}console.log(""+bR+" executed as "+bQ);return bQ};ar=function(bU){var bP,bW,bR,bY,bS,bX,bT,bO,bQ,bV;bT=aG(bU);bX=bu.parse(bT).reverse();bR=bX.shift();bW=aJ[bR.op];bP=bR.args;bO=al(bW,bP);for(bQ=0,bV=bX.length;bQ<bV;bQ++){bR=bX[bQ];bS=Z[bR.op];bY=[bO].concat(bR.args);bO=al(bS,bY)}bO.xyz=ag(bO.xyz,bO.edges());bO.xyz=i(bO.xyz);bO=av(bO);return bO};bw={};L=500;aq=400;A={};H=bh(bJ);d=bh(bJ);z=800;bq=5;N=0;af=0.8;ad=L/2;aM=aq/2;q=new Date();a0=true;aK="rgba(255,255,255,1.0)";br="area";V="fillstroke";bj=0.5;t=false;l=0;k=0;R=[1,0,0];j=["T"];c=function(bQ,bO){var bR,bP;bR=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;bP=new bR();bP.append(bQ);return saveAs(bP.getBlob("text/plain;charset="+document.characterSet),bO)};Q=function(){var bO,bT,bS,bR,bQ,bP;bP={};bO=/\+/g;bQ=/([^&=]+)=?([^&]*)/g;bT=function(bU){return decodeURIComponent(bU.replace(bO," "))};bR=window.location.search.substring(1);while(bS=bQ.exec(bR)){bP[bT(bS[1])]=bT(bS[2])}return bP};bF=function(){var bO;bO=$("#poly");bO.width(L);bO.height(aq);bw=bO[0].getContext("2d");bw.lineWidth=bj;if(a0){return bw.clearRect(0,0,L,aq)}else{bw.clearRect(0,0,L,aq);bw.fillStyle=aK;return bw.fillRect(0,0,L,aq)}};bz=function(){if(a0){return bw.clearRect(0,0,L,aq)}else{bw.clearRect(0,0,L,aq);bw.fillStyle=aK;return bw.fillRect(0,0,L,aq)}};aT=function(b1,b9){var bT,b3,b2,b8,bW,bX,b7,bZ,b0,b6,b5,bU,bR,bP,bO,cb,cd,cc,ca,b4,bY,bV,bS,bQ;b9||(b9=[3,3,3]);bX=_.map(b1.xyz,function(ce){return ce});b1.xyz=_.map(b1.xyz,function(ce){return bk(H,ce)});window.polyobj=bh(b1);b0=au(b1,bq,N,af,z);b4=b1.face;for(b8=bU=0,cb=b4.length;bU<cb;b8=++bU){b3=b4[b8];bw.beginPath();bZ=b3[b3.length-1];bY=O(P(b9,b1.xyz[bZ]),bq,N,af,z),b6=bY[0],b5=bY[1];bw.moveTo(b6+ad,b5+aM);for(bR=0,cd=b3.length;bR<cd;bR++){b7=b3[bR];bV=O(P(b9,b1.xyz[b7]),bq,N,af,z),b6=bV[0],b5=bV[1];bw.lineTo(b6+ad,b5+aM)}bT=G(b1.face_class[b8]);b2=(function(){var cg,ce,cf;cf=[];for(cg=0,ce=b3.length;cg<ce;cg++){b7=b3[cg];cf.push(b1.xyz[b7])}return cf})();bW=be(n(b2),az([1,-1,0]));bT=a((bW/2+0.5)*0.7+0.3,bT);if(V==="fill"||V==="fillstroke"){bw.fillStyle="rgba("+(w(bT[0]*255))+", "+(w(bT[1]*255))+", "+(w(bT[2]*255))+", "+1+")";bw.fill();bw.strokeStyle="rgba("+(w(bT[0]*255))+", "+(w(bT[1]*255))+", "+(w(bT[2]*255))+", "+1+")";bw.stroke()}if(V==="fillstroke"){bw.fillStyle="rgba("+(w(bT[0]*255))+", "+(w(bT[1]*255))+", "+(w(bT[2]*255))+", "+1+")";bw.fill();bw.strokeStyle="rgba(0,0,0, .3)";bw.stroke()}if(V==="stroke"){bw.strokeStyle="rgba(0,0,0, .8)";bw.stroke()}}for(bP=0,cc=b0.length;bP<cc;bP++){b3=b0[bP];bw.beginPath();bZ=b3[b3.length-1];bS=O(P(b9,b1.xyz[bZ]),bq,N,af,z),b6=bS[0],b5=bS[1];bw.moveTo(b6+ad,b5+aM);for(bO=0,ca=b3.length;bO<ca;bO++){b7=b3[bO];bQ=O(P(b9,b1.xyz[b7]),bq,N,af,z),b6=bQ[0],b5=bQ[1];bw.lineTo(b6+ad,b5+aM)}bw.lineWidth=1;bw.strokeStyle="rgba(0,0,0, 1.0)";bw.stroke();bw.lineWidth=bj}return b1.xyz=bX};a8=function(){var bQ,bS,bR,bP,bO;bz();bO=[];for(bQ=bR=0,bP=A.length;bR<bP;bQ=++bR){bS=A[bQ];bO.push(aT(bS,[0+3*bQ,0,3]))}return bO};bG=function(){var bP,bQ,bS,bR,bO;bz();bP=(2*Math.PI)/180*q.getSeconds()*0.1;for(bQ=bR=0,bO=A.length;bR<bO;bQ=++bR){bS=A[bQ];aT(bS,[0+3*bQ,0,3])}return setTimeout(bG,100)};$(function(){var bP,bO;bF();bO=Q();if("recipe" in bO){bP=[bO.recipe];$("#spec").val(bP)}else{bP=[a6(j)];$("#spec").val(bP)}$("#palette").val(bb.reduce(function(bQ,bR){return bQ+" "+bR}));A=_.map(bP,function(bQ){return ar(bQ)});a8();$("#spec").change(function(bQ){bP=$("#spec").val().split(/\s+/g).slice(0,2);A=_.map(bP,function(bR){return ar(bR)});return a8()});$("#palette").change(function(bQ){bb=$(this).val().split(/\s+/g);return a8()});$("#poly").mousewheel(function(bS,bT,bR,bQ){bS.preventDefault();z*=(10+bT)/10;return a8()});$("#poly").mousedown(function(bQ){var bR;bQ.preventDefault();t=true;l=bQ.clientX-$(this).offset().left;k=bQ.clientY-($(this).offset().top-$(window).scrollTop());bR=bp(l,k,ad,aM,bq,N,af,z);if(bR[0]*bR[1]*bR[2]*0===0){R=bR}return d=bh(H)});$("#poly").mouseup(function(bQ){bQ.preventDefault();return t=false});$("#poly").mouseleave(function(bQ){bQ.preventDefault();return t=false});$("#poly").mousemove(function(bT){var bR,bQ,bS;bT.preventDefault();if(t){bR=bT.clientX-$(this).offset().left;bQ=bT.clientY-($(this).offset().top-$(window).scrollTop());bS=bp(bR,bQ,ad,aM,bq,N,af,z);if(bS[0]*bS[1]*bS[2]*0===0&&R[0]*R[1]*R[2]*0===0){H=aA(bA(R,bS),d)}return a8()}});$("#strokeonly").click(function(bQ){V="stroke";return a8()});$("#fillonly").click(function(bQ){V="fill";return a8()});$("#fillandstroke").click(function(bQ){V="fillstroke";return a8()});$("#siderot").click(function(bQ){H=at(aa/2,0,1,0);return a8()});$("#toprot").click(function(bQ){H=at(aa/2,1,0,0);return a8()});$("#frontrot").click(function(bQ){H=aw(0,0,0);return a8()});$("#pngsavebutton").click(function(bT){var bS,bR,bQ;bd(bh(A[0]));bS=$("#poly")[0];bQ=$("#spec").val().split(/\s+/g)[0];bR="polyhedronisme-"+bQ.replace(/\([^\)]+\)/g,"")+".png";return bS.toBlob(function(bU){return saveAs(bU,bR)})});$("#objsavebutton").click(function(bT){var bR,bS,bQ;bS=A[0].toOBJ();bQ=$("#spec").val().split(/\s+/g)[0];bR="polyhedronisme-"+bQ.replace(/\([^\)]+\)/g,"")+".obj";return c(bS,bR)});return $("#x3dsavebutton").click(function(bT){var bR,bQ,bS,bU;bS=o(A[0],true);bU=bS.toVRML();bQ=$("#spec").val().split(/\s+/g)[0];bR="polyhedronisme-"+bQ.replace(/\([^\)]+\)/g,"")+".wrl";return c(bU,bR)})});bC=function(bU,b5){var bP,bW,bV,bT,b1,bR,b2,b3,b4,b0,bZ,bY,bQ,bO,b6,b7,bX,bS;b5||(b5=[3,3,3]);bU.xyz=_.map(bU.xyz,function(b8){return bk(H,b8)});b2=_.map(bU.normals(),function(b8){return bk(H,b8)});aE(bU);bU.face=bU.face.reverse();b4=[];bT=[];bX=bU.face;for(b1=bQ=0,b6=bX.length;bQ<b6;b1=++bQ){bW=bX[b1];b3=[];for(bO=0,b7=bW.length;bO<b7;bO++){b0=bW[bO];bS=O(P(b5,bU.xyz[b0]),bq,N,af,z),bZ=bS[0],bY=bS[1];b3.push([bZ+ad,bY+aM])}b4.push(b3);console.log("twoDface",_.map(b3,function(b8){return" ["+b8[0]+","+b8[1]+"] "}));bP=G(bU.face_class[b1]);bV=(function(){var ca,b8,b9;b9=[];for(ca=0,b8=bW.length;ca<b8;ca++){b0=bW[ca];b9.push(bU.xyz[b0])}return b9})();bR=be(n(bV),az([1,-1,0]));bP=a((bR/2+0.5)*0.7+0.3,bP);bT.push(bP)}return[b4,bT]};h=function(bP,bO,bQ){return(bP[0]-bQ[0])*(bO[1]-bQ[1])-(bP[1]-bQ[1])*(bO[0]-bQ[0])};bK=function(bV,bU,bT,bS){var bR,bP,bO,bX,bQ,bW;bR=h(bV,bU,bS);bP=h(bV,bU,bT);if(bR!==0&&bP!==0&&bR*bP<0){bO=h(bT,bS,bV);bX=h(bT,bS,bU);if(bO*bX<0){bW=bO/(bO-bX);bQ=[bV[0]+bW*(bU[0]-bV[0]),bV[1]+bW*(bU[1]-bV[1])];return bQ}}return false};g=function(bT){var bP,bU,bS,bR,bO,bQ;bP=0;bU=bT[0];bQ=bT.slice(1);for(bR=0,bO=bQ.length;bR<bO;bR++){bS=bQ[bR];bP+=(bU[0]+bS[0])*(bU[1]-bS[1]);bU=bS}return bP*0.5};ax=function(bO){return g(bO)>0};a3=function(bO,bR){var bS,bQ,bT,bP;for(bS=bT=0,bP=bO.length;bT<bP;bS=++bT){bQ=bO[bS];if(ai(bQ[0]-bR[0])+ai(bQ[1]-bR[1])<0.000001){return bS}}return -1};r=function(cu,ct){var b3,b2,bP,bO,cp,cs,cj,b7,cn,cl,bW,bU,b6,b5,cf,b8,cd,cb,cr,cq,co,cm,ck,b4,b0,bZ,bY,bX,bV,bT,bS,bR,bQ,ci,ch,cg,ce,cc,ca,b9,b1;cr=[];for(cq=0,b4=cu.length;cq<b4;cq++){b8=cu[cq];if(a3(cr,b8)===-1){cr.push(b8)}}for(co=0,b0=ct.length;co<b0;co++){b8=ct[co];if(a3(cr,b8)===-1){cr.push(b8)}}bP=[];cj=a3(cr,cu[cu.length-1]);for(cm=0,bZ=cu.length;cm<bZ;cm++){b8=cu[cm];cs=a3(cr,b8);bP.push([cj,cs]);cj=cs}bO=[];cj=a3(cr,ct[ct.length-1]);for(ck=0,bY=ct.length;ck<bY;ck++){b8=ct[ck];cs=a3(cr,b8);bO.push([cj,cs]);cj=cs}b6=(function(){var cw,cx,cv;cv=[];for(cp=cw=0,cx=bP.length-1;0<=cx?cw<=cx:cw>=cx;cp=0<=cx?++cw:--cw){cv.push([])}return cv})();b5=(function(){var cw,cx,cv;cv=[];for(cp=cw=0,cx=bO.length-1;0<=cx?cw<=cx:cw>=cx;cp=0<=cx?++cw:--cw){cv.push([])}return cv})();b7=[];for(cp=ci=0,bX=bP.length;ci<bX;cp=++ci){b3=bP[cp];for(cn=ch=0,bV=bO.length;ch<bV;cn=++ch){b2=bO[cn];if(cf=bK(cr[b3[0]],cr[b3[1]],cr[b2[0]],cr[b2[1]])){b6[cp].push(cf);b5[cn].push(cf);if(a3(cr,cf)===-1){cr.push(cf)}b7.push(a3(cr,cf))}}}bW=[];for(cp=cg=0,bT=b6.length;cg<bT;cp=++cg){cd=b6[cp];if(b6[cp].length>0){b6[cp].sort(function(cw,cv){return aj(cw-cr[bP[cp][0]])-aj(cv-cr[bP[cp][0]])});bW.push([bP[cp][0],a3(cr,b6[cp][0])]);b9=b6[cp].slice(1);for(cl=ce=0,bS=b9.length;ce<bS;cl=++ce){b8=b9[cl];bW.push([a3(cr,b6[cp][cl]),a3(cr,b6[cp][cl+1])])}bW.push([a3(cr,b6[cp][b6[cp].length-1]),bP[cp][1]])}else{bW.push(bP[cp])}}bU=[];for(cp=cc=0,bR=b5.length;cc<bR;cp=++cc){cb=b5[cp];if(b5[cp].length>0){b5[cp].sort(function(cw,cv){return aj(cw-cr[bO[cp][0]])-aj(cv-cr[bO[cp][0]])});bU.push([bO[cp][0],a3(cr,b5[cp][0])]);b1=b5[cp].slice(1);for(cl=ca=0,bQ=b1.length;ca<bQ;cl=++ca){b8=b1[cl];bU.push([a3(cr,b5[cp][cl]),a3(cr,b5[cp][cl+1])])}bU.push([a3(cr,b5[cp][b5[cp].length-1]),bO[cp][1]])}else{bU.push(bO[cp])}}return[cr,bW,bU,b7]};bI=function(bS,b2){var bO,bX,b0,bW,bP,b1,bZ,bV,bU,bT,bY,bR,bQ;bZ=[];for(bV=0,bY=bS.length;bV<bY;bV++){b1=bS[bV];if(a3(bZ,b1)===-1){bZ.push(b1)}}bX=[];bW=a3(bZ,bS[bS.length-1]);for(bU=0,bR=bS.length;bU<bR;bU++){b1=bS[bU];b0=a3(bZ,b1);bX.push([bW,b0]);bW=b0}bP=0;for(bT=0,bQ=bX.length;bT<bQ;bT++){bO=bX[bT];if(bK(bZ[bO[0]],bZ[bO[1]],b2,[b2[0],10000])){bP++}}console.log("pointInpoly called : "+bP,bP%2!==0);if(bP%2===0){return false}else{return true}};bc=function(b2,b1){var bW,bZ,b5,b0,b6,bV,bR,bT,bS,bY,b4,b3,bU,cb,b9,bQ,bP,bO,b7,ca,b8,bX;bX=r(b2,b1.reverse()),b9=bX[0],bT=bX[1],bS=bX[2],b6=bX[3];bW={};for(bQ=0,b7=bT.length;bQ<b7;bQ++){b5=bT[bQ];bW[b5[0]]=b5[1]}bZ={};for(bP=0,ca=bS.length;bP<ca;bP++){b5=bS[bP];bZ[b5[0]]=b5[1]}cb={};if(b6.length===0){if(bI(b1,b2[0])){return[]}else{return[b2]}}b4=[];for(bO=0,b8=b6.length;bO<b8;bO++){b3=b6[bO];bU="B";if(cb[b3+bU]){continue}bY=[];bR=b3;cb[bR+bU]=true;bV=0;while(bR!==b3&&bV<1000){if(bW[b3]&&bZ[b3]){bU=bU==="A"?"B":"A"}if(bU==="A"){bR=bW[bR]}else{bR=bZ[bR]}bY.push(bR);cb[bR+bU]=true}b4.push((function(){var cd,ce,cc;cc=[];for(cd=0,ce=bY.length;cd<ce;cd++){b0=bY[cd];cc.push(b9[b0])}return cc})())}return _.filter(b4,ax)};bd=function(bX){var b6,bZ,bY,bW,b3,b2,b8,b4,bR,b7,b5,b1,bT,bS,bQ,bP,cb,cd,cc,ca,b9,bO,b0,bV,bU;console.log(bX.data());b0=bC(bX),b5=b0[0],bW=b0[1];b3=[];b3.push(b5[0]);bV=b5.slice(1);for(bT=0,cb=bV.length;bT<cb;bT++){bZ=bV[bT];b2=[bZ];for(bS=0,cd=b3.length;bS<cd;bS++){bY=b3[bS];b8=[];for(bQ=0,cc=b2.length;bQ<cc;bQ++){b6=b2[bQ];b8=b8.concat(bc(b6,bY))}b2=b8}b3=b3.concat(b2)}b3=b3.reverse();console.log(b3.length,b3);bR='<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1 Tiny//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11-tiny.dtd">\n<svg version="1.1" baseProfile="tiny" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\n         x="0px" y="0px" width="1024px" height="768px" viewBox="0 0 1024 768" overflow="inherit" xml:space="preserve">\n';b4="</svg>";b7=bR;for(bP=0,ca=b3.length;bP<ca;bP++){b6=b3[bP];b7+='<path fill="#25DF00" stroke="#000000" d="';b7+="M"+b6[0][0]+","+b6[0][1];bU=b6.slice(1);for(bO=0,b9=bU.length;bO<b9;bO++){b1=bU[bO];b7+="L"+b1[0]+","+b1[1]}b7+='z"/>\n'}b7+=b4;return console.log(b7)}}).call(this);